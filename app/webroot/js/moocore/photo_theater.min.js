(function(a,b){if(typeof define==="function"&&define.amd){define(["jquery","mooPhrase","mooMention","mooEmoji","mooBehavior","mooAlert","mooTooltip","mooUser","elastislide"],b)}else{if(typeof exports==="object"){module.exports=b(require("jquery"))}else{a.mooPhotoTheater=b()}}}(this,function(I,j,ad,x,p,C,i,H){var Z;var ac=false;var aa;var Y=false;var O;var k=true;var X;var ab;var m=false;var E=false;var z=0;var U="";var L;var b=false;var F=false;var o=false;var aj,ah,M,K,q,g,T,P;var n=0;var h=0;var c=2;var t=true;function v(){var ak=I("#photo_src");var an=I(window).height();var am,al;if(ak.data("size")&&ak.data("size")!=""){tmp=ak.data("size").split(",");am=tmp[0];al=tmp[1]}if(am&&al){y(ak,am,al)}else{I("<img/>").attr("src",I(ak).attr("src")).load(function(){am=this.width;al=this.height;y(ak,am,al);I.post(mooConfig.url.base+"/photos/ajax_update_size",{photo_id:Z,width:am,height:al})})}}var y=function(ak,am,al){if(al>=am){I(ak).addClass("verticalImagePopup")}else{if(al<(ao-72)){I(ak).addClass("horizionImagePopup")}else{I(ak).addClass("verticalImagePopup")}}if(I("#theaterPhotoComment").length>0){ad.init("theaterPhotoComment");x.init("theaterPhotoComment")}I("#photo_wrapper").spin(false);I("#tag-wrapper").show();I("#photo_src").css("visibility","visible");var ao=0;var an=0;if(I(window).width()>992){ao=I(window).height();an=I("#photo_wrapper").width();I("#photoModal #tag-wrapper").height(ao-72);I("#photoModal #tag-wrapper .photo_img").height(ao-72);I("#photoModal #tag-wrapper").width(an);I("#photoModal .photo_comments").height(ao)}else{ao=I(window).height();an=I(window).width();I("#photoModal #tag-wrapper").height(ao-36);I("#photoModal #tag-wrapper .photo_img").height(ao-36);I("#photoModal #tag-wrapper").width(an)}};var f=function(){I(".photoDetailTags").on("mouseout",function(){var ak=I(this).data();d("0-"+ak.tagId)}).on("mouseover",function(){var ak=I(this).data();ag("0-"+ak.tagId)})};var D=function(){I(".photoDetailRemoveTags").unbind("click");I(".photoDetailRemoveTags").on("click",function(){var ak=I(this).data();R("0-"+ak.id,ak.id)})};var af=function(){I(".showPhotoTheater").unbind("click");I(".showPhotoTheater").on("click",function(){var ak=I(this).data();W(ak.id,ak.thumb)});a();f();D()};var a=function(){I(window).unbind("popstate");I(window).on("popstate",function(){isTheater=S("theater",window.location);if(isTheater!==false){Z=S("pid",window.location);s(Z,"1")}else{I("#photoModal").modal("hide")}})};var S=function(al,ak){var an=ak.search.substring(1);var ao=an.split("&");for(var am=0;am<ao.length;am++){var ap=ao[am].split("=");if(ap[0]==al){if(typeof ap[1]=="undefined"){return""}else{return ap[1]}}}return(false)};var r=function(ak){I.post(mooConfig.url.base+"/photos/ajax_thumb_theater/"+Z+"/"+ak+(h?"?uid="+h:""),function(al){I("#photo_thumbs ul").append(al);if(ak==O){G();return}r(ak+1)})};var ai=function(){I(document).on("click","a.photoModal",function(ak){if(mooConfig.force_login&&!mooConfig.photo_consider_force){if(!H.validateUser()){ak.preventDefault();return}}if(!ac){return}ak.preventDefault();I("body").append('<div class="photo_modal_loading"></div>');I(".photo_modal_loading").spin("large");I.ajax({url:I(this).attr("href"),success:function(al){I("#photoModal .modal-content").html(al);I("#photoModal").modal("show");i.init()}})})};var l=function(){I("#photoModal").on("shown.bs.modal",function(ak){I(".photo_modal_loading").remove();A();v();if(k){G()}});I("#photoModal").on("hidden.bs.modal",function(ak){history.pushState({},"",ab);I("#photoModal .modal-content").html("");I("#photoModal").removeData("bs.modal")})};var A=function(){Z=I("#photo_wrapper").data("photoid");n=I("#photo_wrapper").data("taguid");h=I("#photo_wrapper").data("taguserid");U=I("#photo_wrapper").data("nextphoto");X=I("#photo_wrapper").data("thumbfull");var an,am;var ak=I("#photo_wrapper").data("photocount");var al=I("#photo_wrapper").data("page");if(ak>al*20){O=Math.ceil(ak/20);I("#photo_thumbs").spin();I("#thumb_list_popup").hide();k=false;r(2)}else{k=true}if(!Y){I(window).resize(function(){if(I("#photo-content").length==0){return}if(I("#theaterPhotoComment").is(":focus")){return}if(I(window).width()>992){an=I(window).height();am=I("#photo_wrapper").width();I("#photoModal #tag-wrapper").height(an-72);I("#photoModal #tag-wrapper .photo_img").height(an-72);I("#photoModal #tag-wrapper").width(am);I("#photoModal .photo_comments").height(an)}else{an=I(window).height();am=I(window).width();I("#photoModal #tag-wrapper").height(an-36);I("#photoModal #tag-wrapper .photo_img").height(an-36);I("#photoModal #tag-wrapper").width(am)}v();I("#photo_src").css("visibility","visible")});I(document).keydown(function(ao){if(!I("#theaterPhotoComment").is(":focus")&&!I('[id^="message_item_comment_edit"]').is(":focus")){if(ao.keyCode==37){I("#photo_left_arrow_lg").trigger("click")}else{if(ao.keyCode==39){I("#photo_right_arro_lgw").trigger("click")}}}});Y=true}I("#photo_thumbs ul li").unbind("click");I("#photo_thumbs ul li").click(function(){I("#photo_thumbs ul li").removeClass("active");I(this).addClass("active")});I("#photo_wrapper").spin("large");I("#tag-wrapper").hide();if(n){url=Z+"/uid:"+n+"?pid="+Z+"&theater"}else{if(h){url=Z+"?uid="+h+"&pid="+Z+"&theater"}else{url=Z+"?pid="+Z+"&theater"}}ab=window.location.href;window.history.pushState({photo_id:Z},"",mooConfig.url.base+"/photos/view/"+url);window.history.replaceState({photo_id:Z},"",mooConfig.url.base+"/photos/view/"+url);L=window.location;u()};var u=function(){I("#photo_wrapper .toogleThumb").unbind("click");I("#photo_wrapper .toogleThumb").click(function(){I("#photo_thumbs").toggle();if(I("#thumb_list_popup").is(":visible")){aa.setCurrent(I("#photo_thumb_"+Z).index())}});I("#set_photo_cover").unbind("click");I("#set_photo_cover").click(function(){J()});E=false;I("#tagPhoto").unbind("click");I("#tagPhoto").click(function(){if(!E){w()}else{N()}});I("#set_profile_picture").unbind("click");I("#set_profile_picture").click(function(){Q()});I("#delete_photo").unbind("click");I("#delete_photo").click(function(){ae()});I("#photo_close_icon").unbind("click");I("#photo_close_icon").click(function(){history.pushState({},"",ab)});I(".sharethis_theater").hideshare({media:X,linkedin:false,link:L});p.registerImageComment();var ak=500;if(mooConfig.isMobile){ak=300}if(I("#theaterComments").height()>ak){I("#theaterComments").slimScroll({height:ak+"px",start:"top"}).bind("slimscroll",function(al,am){if(am=="bottom"){if(mooConfig.autoLoadMore!=""){if(I("#photoModal .view-more").length>0){I("#photoModal .view-more").before('<div style="text-align: center" class="loading"><img src="'+mooConfig.url.base+'/img/loading.gif" /></div>');I("#photoModal .view-more").find("a").trigger("click");t=false}}}})}I("#theaterPhotoComment").autogrow()};var V=function(){I("#tag-target").fadeOut();I("#tag-input").fadeOut();I("#tag-name").val("")};var N=function(){E=false;I("#tag-wrapper img").css("cursor","default");I("#tagPhoto a").html(j.__("tag_photo"));I("#tag-name").unbind();I("#tag-submit").unbind();V()};var w=function(){E=true;I("#tag-wrapper img").css("cursor","crosshair");I("#tagPhoto a").html(j.__("done_tagging"));I("#tag-wrapper img").unbind("click");I("#tag-wrapper img").click(function(ak){if(E){M=ak.pageX-I("#tag-wrapper").offset().left;K=ak.pageY-I("#tag-wrapper").offset().top;q=I("#tag-target").outerWidth();g=I("#tag-target").outerHeight();aj=M-q/2;ah=K-g/2;T=M+q/2;P=K-g/2;if(I("#tag-target").css("display")=="block"){I("#tag-target").animate({left:aj,top:ah},500);I("#tag-input").animate({left:T,top:P},500)}else{I("#tag-target").css({left:aj,top:ah}).fadeIn();I("#tag-input").css({left:T,top:P}).fadeIn()}I("#tag-name").focus();I("#friends_list").html(I("#friends").html());I(".tagFriends").unbind("click");I(".tagFriends").on("click",function(){var al=I(this).data();e(al.id,al.tagValue)})}});I("#tag-cancel").unbind("click");I("#tag-cancel").click(function(){V();return false});I("#tag-name").keyup(function(ak){if(ak.keyCode==13){e(0,"")}});I("#tag-submit").unbind("click");I("#tag-submit").click(function(){e(0,"");return false})};function B(){var ak=I("#preload").html();if(ak!=""){I("#preload").html("");element=I("<div>"+ak+"</div>");data=element.find("#photo_wrapper").data();Z=data.photoid;n=data.taguid;h=data.taguserid;U=data.nextphoto;X=data.thumbfull;I("#photo-content #tag-wrapper").hide();I("#photo-content .photo_comments").hide();if(element.find(".photo_comments").html()){I("#photo-content .photo_comments").html(element.find(".photo_comments").html());I("#photo-content .photo_comments").show()}I("#photo_wrapper .info").html(element.find(".info").html());I("#photo-content #tag-wrapper").html(element.find("#tag-wrapper").html());I("#photo-content #lb_description").html("");I("#photo-content #lb_description").html(element.find("#lb_description").html());I("#photo_wrapper").spin("large");u();v()}}function s(an,ak){if(ak=="1"){if(I("#thumb_list_popup").is(":visible")){aa.setCurrent(I("#photo_thumb_"+an).index())}}I("#theaterPhotoComment").destroyOverlayInstance(I("#theaterPhotoComment"));Z=an;I("#thumb_list_popup .active").removeClass("active");I("#photo_thumb_"+Z).addClass("active");I("#photo_wrapper").spin("large");var al="";if(n){al=an+"/uid:"+n}else{al=an}var am=al+"/time/"+(new Date()).getTime();if(h){am+="?uid="+h+"&theater"}else{am+="?theater"}I("#preload").load(mooConfig.url.base+"/photos/ajax_view_theater/"+am,{noCache:0},function(){E=false;I("#photoModal .slimScrollDiv").attr("style","");I("#theaterComments").attr("style","");B();i.init()})}function W(an,ak){if(ak=="1"){if(I("#thumb_list_popup").is(":visible")){aa.setCurrent(I("#photo_thumb_"+an).index())}}I("#theaterPhotoComment").destroyOverlayInstance(I("#theaterPhotoComment"));Z=an;I("#thumb_list_popup .active").removeClass("active");I("#photo_thumb_"+Z).addClass("active");I("#photo_wrapper").spin("large");var al="";if(n){al=an+"/uid:"+n}else{al=an}var am=al+"/time/"+(new Date()).getTime();if(h){am+="?uid="+h+"pid="+an+"&theater";al+="?uid="+h+"pid="+an+"&theater"}else{am+="?pid="+an+"&theater";al+="?pid="+an+"&theater"}I("#preload").load(mooConfig.url.base+"/photos/ajax_view_theater/"+am,{noCache:0},function(){E=false;I("#photoModal .slimScrollDiv").attr("style","");I("#theaterComments").attr("style","");B();i.init()});window.history.pushState({photo_id:Z},"",mooConfig.url.base+"/photos/view/"+al)}var e=function(ak,am){if(ak!=""||I("#tag-name").val()!=""){var al="left:"+aj+"px; top:"+ah+"px";I("#photo_wrapper").spin("large");I.post(mooConfig.url.base+"/photos/ajax_tag",{photo_id:Z,uid:ak,value:I("#tag-name").val(),style:al},function(ao){I("#photo_wrapper").spin(false);var an=I.parseJSON(ao);if(an.result==1){if(ak){am='<a href="'+mooConfig.url.base+"/users/view/"+ak+'">'+am+"</a>"}else{am=I("#tag-name").val()}I("#tags").append('<span id="hotspot-item-0-'+an.id+'" data-tag-id="'+an.id+'" class="photoDetailTags">'+am+'<a href="javascript:void(0)" class="photoDetailRemoveTags" data-id="'+an.id+'"><i class="material-icons cross-icon-sm">clear</i></a></span>');I("#tag-wrapper .photo_img").append('<div id="hotspot-0-'+an.id+'" class="hotspot" style="'+al+'"><span>'+am+"</span></div>");V();z++;af()}else{C.alert(an.message)}})}};var R=function(ak,al){I("#hotspot-item-"+ak).fadeOut();I("#hotspot-"+ak).fadeOut();I.post(mooConfig.url.base+"/photos/ajax_remove_tag",{tag_id:al})};var ag=function(ak){I("#hotspot-"+ak).addClass("hotspothover")};var d=function(ak){I("#hotspot-"+ak).removeClass("hotspothover")};var G=function(){b=false;aa=I("#thumb_list_popup").elastislide({minItems:2,onReady:function(){aa.setCurrent(I("#photo_thumb_"+Z).index());I("#photo_thumbs").spin(false);I("#photo_thumbs").css("visibility","visible");if(!b){b=true;I("#photo_thumbs").toggle()}}});I("#photo_thumb_"+Z).addClass("active")};var J=function(){I("#set_cover").spin("custom");I.post(mooConfig.url.base+"/users/set_photo_as_cover",{photo_id:Z},function(ak){var al=I.parseJSON(ak);location.assign(al.url)})};function ae(){U=U!=""?U:"0";C.confirm(j.__("are_you_delete"),mooConfig.url.base+"/photos/ajax_remove/photo_id:"+Z+"/next_photo:"+U)}var Q=function(){I("#set_avatar").spin("custom");I.post(mooConfig.url.base+"/users/set_photo_as_profile_picture",{photo_id:Z},function(ak){var al=I.parseJSON(ak);window.location=al.url})};return{init:function(){if(!m){l()}m=true;ai()},initShowPhoto:af,start:function(){A()},submitTag:function(ak,al){e(ak,al)},removeTag:function(al,ak){R(al,ak)},hideTag:function(ak){d(ak)},showTag:function(ak){ag(ak)},showPhotoWrapper:function(){B()},showPhoto:function(al,ak){if(typeof ak=="undefined"){ak=false}W(al,ak)},setActive:function(ak){ac=ak}}}));