(function(h,B){"function"===typeof define&&define.amd?define(["jquery","overlay","textcomplete","bloodhound"],B):"object"===typeof exports?module.exports=B(require("jquery")):h.mooMention=B()})(this,function(h){function B(a,f){var e=String(a.data.obj.value),d=h(a.data.mirrorCheckSpell).html();d=jQuery("<div />").html(d).text();if(e!=d){a:{var c=d;var g=e.split(/(\s+)/);c=c.split(/(\s+)/);for(var q=index=0;q<g.length;q++){if(g[q]!=c[q]){g={beforeChanged:c[q],afterChanged:g[q],index:index};break a}index+=
c[q].length}g=void 0}e.split("");d.split("");d=g.beforeChanged;c=g.afterChanged;if(void 0!=d&&void 0!=c){if(d.length<c.length&&(rangeSpell=c.length-d.length,0<Object.keys(b).length))for(var k in b)b.hasOwnProperty(k)&&b[k].start>g.index&&(b[k].start+=rangeSpell,b[k].end+=rangeSpell);if(d.length>c.length&&(rangeSpell=d.length-c.length,0<Object.keys(b).length))for(k in b)b.hasOwnProperty(k)&&b[k].start>g.index&&(b[k].start-=rangeSpell,b[k].end-=rangeSpell)}h(a.data.mirrorCheckSpell).html(e);k=a.data.mirror;
d=[];e=e.split("");g="";if(0<Object.keys(b).length){c=0;for(m in b)b.hasOwnProperty(m)&&(d[c]=b[m],d[c].key=m,c++);for(c=0;c<d.length-1;c++)for(j=c+1;j<d.length;j++)if(d[c].start>d[j].start){var m=d[j];d[j]=d[c];d[c]=m}}for(c=0;c<e.length;c++){m=!1;if(0<d.length)for(j=0;j<d.length;j++)c==d[j].start&&(g+="@["+d[j].key+":"+e[c],m=!0),c==d[j].end&&(g+="]"+e[c],m=!0);m||(g+=e[c])}for(j=0;j<d.length;j++)d[j].end==e.length&&(g+="]");k.value=g;w(h(a.data.obj))}}var F,G,C={},x=[],v,L,H,b={},z={},M={},N=!1,
A=[];if(mooConfig.isMention)h("body").on("focus","textarea",function(){var a=h(this).siblings("input.messageHidden");0<a.length&&(D(h(this)),O(a.val(),h(this)))});h("body").on("keydown",function(a){a.stopPropagation();if(116==a.which){var b=h("textarea");h.each(b,function(b,d){if(""!=h(d).val())return a.preventDefault(),window.confirm("This page is asking you to confirm that you want to leave - data you have entered may not be saved.")&&(h("textarea").val(""),h(".messageHidden").val(""),window.location.reload()),
!1})}});var I=function(a,f){h("#"+f).destroyOverlayInstance(h("#"+f));h("#"+f).textcomplete([{mentions:a,match:/\B@(\w*)$/,search:function(a,b){console.log(a);L=a.length;b(h.map(this.mentions,function(c,b){if(-1!=x.indexOf(b))return null;a:{var e=a.toLowerCase();var d="\\()[]^{}*+?$.".split(""),f;for(f in d)if(d.hasOwnProperty(f)&&-1!=e.indexOf(d[f])){e=!0;break a}e=!1}if(e)return null;e=new RegExp("\\b"+a.toLowerCase(),"g");if(c)return c.toLowerCase().match(e)?b:null}))},template:function(a){return'<img src="'+
M[a]+'" class="user_avatar_small" /> '+C[a]},index:1,replace:function(a){return C[a]}}],{appendTo:"body",zIndex:1055}).overlay([{match:{},css:{"background-color":"#CAD8F4"}}]).on({"textComplete:select":function(a,d,c){a=C[d];for(var e in C)if(d==e){c=h(this).prop("selectionStart")-a.length+1;var f=void 0,k=c,m=void 0,n={};if(0<Object.keys(b).length)for(f in b)b.hasOwnProperty(f)&&k>=b[f].end&&(k+=replaceLength[f].length-b[f].length,m+=replaceLength[f].length-b[f].length);n.start=k;n.end=m;var p=n;
f=void 0;n=e;k=a;m=h(this);p=p.start;var t=L,r=document.createElement("textarea");r.innerHTML=k;k=r.value;r=m.siblings(".messageHidden");var u=r.val(),y="["+n+":"+k+"]",l=u.substring(0,p),v=u.substring(p);v=v.replace(u.substring(p,p+t),y);r.val(l+v);m.siblings(".checkSpell").html(m.val());replaceLength[n]={start:p-1,end:p+y.length,length:y.length+1};n=y.length+1;if(0<Object.keys(b).length)for(f in b)b.hasOwnProperty(f)&&p-1<=b[f].start&&(replaceLength[f].start=replaceLength[f].start-(t+1)+n,replaceLength[f].end=
replaceLength[f].end-(t+1)+n,b[f].start=b[f].start-(t+1)+k.length,b[f].end=b[f].end-(t+1)+k.length);w(m);x.push(e);--c;b[e]={start:c,end:h(this).prop("selectionStart"),length:h(this).prop("selectionStart")-c};w(h(this),!0)}}});0==h("#"+f).siblings("input.messageHidden").length&&("edit_activity"==H?h("#"+f).after('<input type="hidden" id="'+f+'_hidden" name="data[message]" class="messageHidden" /><div class="checkSpell" style="display: none"></div>'):h("#"+f).after('<input type="hidden" name="data[message]" class="messageHidden" /><div class="checkSpell" style="display: none"></div>'));
v=h("#"+f).siblings(".messageHidden")[0];mirrorCheckSpell=jQuery("#"+f).siblings(".checkSpell")[0];"edit_activity"==H&&(v.value=G);h("#"+f).on("keypress keydown",{obj:jQuery("#"+f)[0],mirror:v,mirrorCheckSpell:mirrorCheckSpell},P);h("#"+f).bind("input",{obj:jQuery("#"+f)[0],mirror:v,mirrorCheckSpell:mirrorCheckSpell},B);h("#"+f).on("paste",{obj:jQuery("#"+f)[0],mirror:v,mirrorCheckSpell:mirrorCheckSpell},V);h("#"+f).on("cut",{obj:jQuery("#"+f)[0],mirror:v,mirrorCheckSpell:mirrorCheckSpell},W)},O=
function(a,f){var e=0,d=0;D(f);var c=a.replace(/@\[(\d+):([^\]]+)\]/g,function(c,f,k){x.push(f);replaceLength[f]={start:a.indexOf(c),end:a.indexOf(c)+c.length,length:c.length};var g=a.indexOf(c)-e+d;b[f]={start:g,end:g+k.length,length:k.length};e+=c.length;d+=k.length;return k});f.val(c);w(f)},P=function(a,f){if(X(a)||"undefined"!=typeof f){var e=h(a.data.obj).prop("selectionStart"),d=e,c=h(a.data.obj).prop("selectionEnd"),g=c,q=String(a.data.mirror.value),k=String(a.data.obj.value),m=!1,n=0;if("keypress"!=
a.type||!a.metaKey||99!=a.which){if(0<Object.keys(b).length){var p=!1;for(l in b){if(p&&!m)break;if(b.hasOwnProperty(l)){if(d>=b[l].end)e=u(d),c=u(d,g),d==b[l].end&&"keydown"==a.type&&8==a.which&&d==g&&(a.preventDefault(),d=Q(d-1,k,l),n=g-d,E(a,k,d,g),c=R(l,e,c,d,g),e=c.selectionStart,c=c.selectionEnd,p=!0);else{if(g>b[l].start&&d<b[l].start||g>b[l].end&&d<b[l].end){c=String(a.data.obj.value);e=u(d);q=S(e,c,q,d);e=c.substring(g);m=13==a.which?"\\n":32==a.which?" ":"keydown"!=a.type||46!=a.which&&
8!=a.which?"undefined"==typeof f||"cut"!=a.type&&"delete"!=a.type?String.fromCharCode(a.which):"":"";a.data.mirror.value=q+m+e;J(l,d);jQuery(a.data.mirrorCheckSpell).html(k.substring(0,d)+m+k.substring(g));w(h(a.data.obj));return}if(d==b[l].start||d==b[l].start&&g==b[l].end){if(d!=g||d==g&&"keydown"==a.type&&46==a.which)a.preventDefault(),p=0,d!=g&&8==a.which?p=1:46==a.which&&(p=1),u(d),u(d,g),g=T(d,k,l),c=g<b[l].end?1:0,g==b[l].end&&a.preventDefault(),p=g<b[l].end?p:0,n=g-d,e=replaceLength[l].end-
b[l].length-1,c=e+n+c,g+=p,E(a,k,d,g),U(e,c,l),p=!0}else if(b[l].start<d&&b[l].end>d){if("keydown"==a.type&&46==a.which||8==a.which)a.preventDefault(),e=u(d),c=u(d,g),d==g&&(8==a.which&&d>b[l].start?(g--,d--):46==a.which&&g<b[l].end&&(g++,d++),d>b[l].start&&d--),d=Q(d,k,l),g=T(g,k,l),g+=g<b[l].end&&d==b[l].start?1:0,n=g-d,E(a,k,d,g),c=R(l,e,c,d,g),e=c.selectionStart,c=c.selectionEnd;else{c=String(a.data.obj.value);q=q.substring(0,replaceLength[l].start);q+=c.substring(b[l].start,d);e=c.substring(g);
m=13==a.which?"\\n":32==a.which?" ":"keydown"==a.type&&46==a.which||8==a.which?"":"undefined"==typeof f||"cut"!=a.type&&"delete"!=a.type?String.fromCharCode(a.which):"";a.data.mirror.value=q+m+e;J(l,d);jQuery(a.data.mirrorCheckSpell).html(k.substring(0,d)+m+k.substring(g));w(h(a.data.obj));return}p=!0}}if(0==b[l].length){e=replaceLength[l].start;c=replaceLength[l].end+n;for(var t in x)x[t]==l&&x.splice(t,1);delete replaceLength[l];delete b[l];K(e,c,a,y);E(a,k,d,g);w(h(a.data.obj));var r=e;var v=c;
var y=n;m=!0;break}}}}m||("undefined"!=typeof r&&"undefined"!=typeof y?K(r,v,a,y):K(d,g,a));13==a.which?m="\n":32==a.which?m=" ":"keydown"!=a.type||46!=a.which&&8!=a.which?m="undefined"==typeof f||"cut"!=a.type&&"delete"!=a.type?"keypress"!=a.type||!a.metaKey||118!=a.which&&120!=a.which&&99!=a.which&&97!=a.which?String.fromCharCode(a.which):"":"":(m="",e==c&&(8==a.which?--e:46==a.which&&(c+=1)),d==g&&(8==a.which?--d:46==a.which&&(g+=1)));var l=q.substring(0,e);q=q.substring(c);a.data.mirror.value=
l+m+q;jQuery(a.data.mirrorCheckSpell).html(k.substring(0,d)+m+k.substring(g));w(h(a.data.obj))}}},V=function(a){var f=h(a.data.obj).prop("selectionStart"),e=f,d=h(a.data.obj).prop("selectionEnd"),c=d,g="",q,k=String(a.data.mirror.value),m=String(a.data.obj.value);setTimeout(function(){var n=String(a.data.obj.value),p=h(a.data.obj).prop("selectionStart");h(a.data.obj).prop("selectionEnd");q=p-e-(c-e);g=n.substring(e,p);if(0<Object.keys(b).length)for(var t in b)if(b.hasOwnProperty(t))if(e==c&&(e<=b[t].start||
c>=b[t].end))f=u(e),d=u(e,c);else{f=u(e);var r=S(f,n,k,e);n=n.substring(p);a.data.mirror.value=r+g+n;J(t,e);jQuery(a.data.mirrorCheckSpell).html(m.substring(0,e)+g+m.substring(c));return}t=q;if(0<Object.keys(b).length)for(r in b)b.hasOwnProperty(r)&&e<=b[r].start&&(replaceLength[r].start+=t,replaceLength[r].end+=t,b[r].start+=t,b[r].end+=t);t=k.substring(0,f);n=k.substring(d,k.length);k=t+g+n;a.data.mirror.value=k;jQuery(a.data.mirrorCheckSpell).html(m.substring(0,e)+g+m.substring(c))},10)},W=function(a){P(a,
!0)},Y=function(a){var b=a.data.obj,e=a.data.mirror;setTimeout(function(){e.value=String(b.value);D(h(b))},10)},U=function(a,f,e){0<Object.keys(b).length&&(a=0==f-a?1:f-a,replaceLength[e].end-=a,replaceLength[e].length-=a,b[e].end-=a,b[e].length-=a)},X=function(a){var f=a.which;if("keypress"==a.type&&8!=f)return 0!=f?a.ctrlKey?(!a.ctrlKey||90!=f&&89!=f||Y(a),!1):"none"!=h('ul[id^="textcomplete-dropdown"]').css("display")&&13==f?!1:!0:!1;if("keydown"==a.type){if(46==f||8==f)return!0;if(116==f)0<Object.keys(b).length&&
(a.preventDefault(),a.stopPropagation(),window.confirm("This page is asking you to confirm that you want to leave - data you have entered may not be saved.")&&(h("textarea").val(""),h(".messageHidden").val(""),window.location.reload()));else return!1}},K=function(a,f,e,d){if(0<Object.keys(b).length)for(var c in b)b.hasOwnProperty(c)&&(a<b[c].start&&(8!=e.which||0!=a||0!=f)?"keydown"==e.type&&(46==e.which||8==e.which)||"cut"==e.type?(replaceLength[c].start-=f==a?1:f-a,replaceLength[c].end-=f==a?1:
f-a,"undefined"==typeof d||0==d?(b[c].start-=f==a?1:f-a,b[c].end-=f==a?1:f-a):(b[c].start-=d,b[c].end-=d)):(replaceLength[c].start=replaceLength[c].start-(f-a)+1,replaceLength[c].end=replaceLength[c].end-(f-a)+1,"undefined"==typeof d||0==d?(b[c].start=b[c].start-(f-a)+1,b[c].end=b[c].end-(f-a)+1):(b[c].start=b[c].start-d+1,b[c].end=b[c].end-d+1)):a==b[c].start&&("keydown"!=e.type||46!=e.which&&8!=e.which)?(replaceLength[c].start=replaceLength[c].start-(f-a)+1,replaceLength[c].end=replaceLength[c].end-
(f-a)+1,"undefined"==typeof d||0==d?(b[c].start=b[c].start-(f-a)+1,b[c].end=b[c].end-(f-a)+1):(b[c].start=b[c].start-d+1,b[c].end=b[c].end-d+1)):a==b[c].start&&8==e.which&&0<replaceLength[c].start&&0<b[c].start&&a==f!=0&&(replaceLength[c].start--,replaceLength[c].end--,b[c].start--,b[c].end--))},J=function(a,f){for(var e in b)b.hasOwnProperty(e)&&"undefined"!=typeof f&&b[e].start<=f&&b[e].end>f&&(a=e);var d=b[a].start,c={},g={},h=[];for(e in b)b.hasOwnProperty(e)&&b[e].start<d&&(c[e]=b[e],g[e]=replaceLength[e],
h.push(e));b=c;replaceLength=g;x=h},u=function(a,f){var e=a,d=f,c;for(c in b)b.hasOwnProperty(c)&&b[c].end<=a&&("undefined"==typeof f?e+=replaceLength[c].length-b[c].length:d+=replaceLength[c].length-b[c].length);return"undefined"==typeof f?e:d},S=function(a,f,e,d){var c="",g;for(g in b)b.hasOwnProperty(g)&&a>replaceLength[g].start&&a<replaceLength[g].end&&(a=replaceLength[g].start,c=f.substring(b[g].start,d));return e.substring(0,a)+c},D=function(a){b={};replaceLength={};x=[];w(a)},w=function(a,
f){F=a.getInstanceOverlay(a);a.revokeOverlay([{match:b}],F);a.reRenderTextOnOverlay(F)},Q=function(a,f,e){for(var d=f.substr(a,1);" "!=d&&a>b[e].start;d=f.substr(a,1))a--;return a},T=function(a,f,e){for(var d=f.substr(a,1);" "!=d&&a<b[e].end;d=f.substr(a,1))a++;return a},R=function(a,f,e,d,c){f=u(d);e=u(d,c);e-=replaceLength[a].start;f-=replaceLength[a].start;e=b[a].length-e;f=b[a].length-f;f=replaceLength[a].end-f-1;e=replaceLength[a].end-e-1;U(f,e,a);return{selectionStart:f,selectionEnd:e}},E=function(a,
b,e,d){var c=b.substring(0,e);b=b.substring(d);a.data.obj.value=c+b;a=a.data.obj;a.setSelectionRange?(a.focus(),a.setSelectionRange(e,e)):a.createTextRange&&(a=a.createTextRange(),a.collapse(!0),a.moveEnd("character",e),a.moveStart("character",e),a.select())};return{init:function(a,b){if(mooConfig.isMention){H=b;switch(b){case "edit_activity":G=h("#"+a).val(),O(G,h("#"+a))}-1==h.inArray(a,A)&&(0==Object.keys(z).length?N?A.push(a):(N=!0,A.push(a),(new Bloodhound({datumTokenizer:function(a){return Bloodhound.tokenizers.whitespace(a.name)},
queryTokenizer:Bloodhound.tokenizers.whitespace,prefetch:{url:mooConfig.url.base+"/users/friends.json",cache:!1,filter:function(a){h.each(a.data,function(a,b){z[b.id]=b.name;C[b.id]=b.name;M[b.id]=b.avatar});for(i=0;i<A.length;i++)I(z,A[i]);A=[];return h.map(a.data,function(a){return a})}},identify:function(a){return a.id}})).initialize()):I(z,a))}},resetMention:function(a){a.siblings("input.messageHidden").val("");a.siblings("div.textoverlay").html("");D(a)},reConfigOverlay:w,addMention:function(a,
b,e){z[a]=b;I(z,e)}}});