(function(a,d){"function"===typeof define&&define.amd?define("jquery mooPhrase mooMention mooEmoji mooAttach mooBehavior mooLike mooTooltip mooAlert autogrow overlay".split(" "),d):"object"===typeof exports?module.exports=d(require("jquery")):a.mooComment=d()})(this,function(a,d,g,k,q,f,E,h,F){var l=[],m=[],t=function(){a(".showCommentBtn").unbind("onfocus");a(".showCommentBtn").on("focus",function(){var b=a(this).data();r(b.id)})},u=function(){a(".removeItemComment").unbind("click");a(".removeItemComment").click(function(){var b=
    a(this).data();G(b.id,b.photoComment)})},w=function(){a(".editItemComment").unbind("click");a(".editItemComment").click(function(){var b=a(this).data();v(b.id,b.photoComment)})},H=function(b){0==a("#activity_comment_edit_"+b).length&&a.post(mooConfig.url.base+"/activities/ajax_loadActivityCommentEdit/"+b,function(c){a("#activity_feed_comment_text_"+b).hide();a(c).insertAfter(a("#activity_feed_comment_text_"+b));q.registerAttachCommentEdit("activity",b);l.push(b);a("textarea:not(.no-grow)").autogrow();
    g.init(a(c).find("textarea").attr("id"),"edit_activity");k.init(a(c).find("textarea").attr("id"),"edit_activity");a("body").trigger("afterShowFormEditCommentCallback",[])})},I=function(b){a.fn.SimpleModal({btn_ok:d.__("btn_ok"),btn_cancel:d.__("cancel"),callback:function(){a.post(mooConfig.url.base+"/activities/ajax_removeComment",{id:b},function(){a("#comment_"+b).fadeOut("normal",function(){a("#comment_"+b).remove();a("body").trigger("afterRemoveActivityCommentCallback",[])})})},title:d.__("please_confirm"),
    contents:d.__("please_confirm_remove_this_activity"),model:"confirm",hideFooter:!1,closeButton:!1}).showModal()},y=function(){a(".removePhotoComment").unbind("click");a(".removePhotoComment").on("click",function(){var b=a(this).data();x(b.type,b.id)})},J=function(){a(".cancelEditActivityComment").unbind("click");a(".cancelEditActivityComment").click(function(){var b=a(this).data();n(b.id)})},K=function(){a(".confirmEditActivityComment").unbind("click");a(".confirmEditActivityComment").click(function(){var b=
    a(this).data();z(b.id)})},L=function(){a(".cancelEditItemComment").unbind("click");a(".cancelEditItemComment").click(function(){var b=a(this).data();p(b.id,b.photoComment)})},M=function(){a(".confirmEditItemComment").unbind("click");a(".confirmEditItemComment").click(function(){var b=a(this).data();A(b.id,b.photoComment)})},B=function(b){if(""!=a.trim(a("#postComment").val())||""!=a.trim(a("#theaterPhotoComment").val())||""!=a("#comment_image_"+b).val())if("1"===mooConfig.comment_sort_style){a(".shareButton").addClass("disabled");
    a(".shareButton").append('<i class="icon-refresh icon-spin"></i>');var c="";a("#commentForm").length&&(c=a("#commentForm").serialize());a("#theaterPhotoCommentForm").length&&(c=a("#theaterPhotoCommentForm").serialize());a.post(mooConfig.url.base+"/comments/ajax_share",c,function(c){a(".shareButton").removeClass("disabled");a(".shareButton i").remove();a(".commentForm").css("height","35px");a("#postComment").length&&a("#postComment").val("");a("#theaterPhotoComment").length&&a("#theaterPhotoComment").val("");
        ""!=c&&(a("#theaterComments").length?a("#theaterComments").append(c):a("#comments").append(c),a(".slide").slideDown(),a("#theaterComments").length||a("#comment_count").html(parseInt(a("#comment_count").html())+1),a("#comment_preview_image_"+b).html(""),a("#comment_image_"+b).val(""),a("#comment_button_attach_"+b).show(),f.registerImageComment(),c=a("#postComment"),g.resetMention(c),c=a("#theaterPhotoComment"),g.resetMention(c),h.init());a("body").trigger("afterPostCommentCallback",[])})}else a(".shareButton").addClass("disabled"),
    a(".shareButton").prepend('<i class="icon-refresh icon-spin"></i>'),c="",a("#commentForm").length&&(c=a("#commentForm").serialize()),a("#theaterPhotoCommentForm").length&&(c=a("#theaterPhotoCommentForm").serialize()),a.post(mooConfig.url.base+"/comments/ajax_share",c,function(c){a(".shareButton").removeClass("disabled");a(".shareButton i").remove();a(".commentForm").css("height","35px");a("#postComment").length&&a("#postComment").val("");a("#theaterPhotoComment").length&&a("#theaterPhotoComment").val("");
    ""!=c&&(a("#theaterComments").length?a("#theaterComments").prepend(c):a("#comments").prepend(c),a(".slide").slideDown(),a("#theaterComments").length||a("#comment_count").html(parseInt(a("#comment_count").html())+1),a("#comment_preview_image_"+b).html(""),a("#comment_image_"+b).val(""),a("#comment_button_attach_"+b).show(),f.registerImageComment(),c=a("#postComment"),g.resetMention(c),c=a("#theaterPhotoComment"),g.resetMention(c),h.init());a("body").trigger("afterPostCommentCallback",[])});else a.fn.SimpleModal({btn_ok:d.__("btn_ok"),
    model:"modal",title:d.__("warning"),contents:d.__("comment_empty")}).showModal()},n=function(b){a("#message_activity_comment_edit_"+b).siblings(".textoverlay")&&a("#message_activity_comment_edit_"+b).destroyOverlayInstance(a("#message_activity_comment_edit_"+b));a("#activity_feed_comment_text_"+b).show();a("#activity_comment_edit_"+b).remove();b=a.inArray(b,l);l.splice(b,1);a("body").trigger("afterCancelFormEditCommentCallback",[])},z=function(b){if(""!=a.trim(a("#message_activity_comment_edit_"+
    b).val())||""!=a("#activity_comment_attach_id_"+b).val()){var c=0!=a("#message_activity_comment_edit_"+b+"_hidden").length?a("#message_activity_comment_edit_"+b+"_hidden").val():a("#message_activity_comment_edit_"+b).val();a.post(mooConfig.url.base+"/activities/ajax_editActivityComment/"+b,{comment_attach:a("#activity_comment_attach_id_"+b).val(),message:c},function(c){a("#message_activity_comment_edit_"+b).siblings(".textoverlay")&&a("#message_activity_comment_edit_"+b).destroyOverlayInstance(a("#message_activity_comment_edit_"+
    b));a("#activity_feed_comment_text_"+b).html(a(c).html());a("#history_activity_comment_"+b).show();f.registerImageComment();n(b)})}},G=function(b,c){a.fn.SimpleModal({btn_ok:d.__("btn_ok"),btn_cancel:d.__("btn_cancel"),callback:function(){a.post(mooConfig.url.base+"/comments/ajax_remove",{id:b},function(){a("#itemcomment_"+b).fadeOut("normal",function(){a("#itemcomment_"+b).remove();"0"!=c?a("#comment_count").html(parseInt(a("#comment_count").html())-1):a("#photo_comment_"+b).remove()})})},title:d.__("please_confirm"),
    contents:d.__("confirm_delete_comment"),model:"confirm",hideFooter:!1,closeButton:!1}).showModal()},v=function(b,c){if(0==a("#item_comment_edit_"+b).length){var e=0;"0"!=c&&(e=1);a.post(mooConfig.url.base+"/comments/ajax_loadCommentEdit/"+b,{isPhotoComment:e},function(e){var d="#item_feed_comment_text_";"0"!=c&&(d="#photo_feed_comment_text_");a(d+b).hide();a(e).insertAfter(a(d+b));q.registerAttachCommentEdit("item",b);m.push(b);a("textarea:not(.no-grow)").autogrow();g.init(a(e).find("textarea").attr("id"),
    "edit_activity");k.init(a(e).find("textarea").attr("id"))})}},p=function(b,c){a("#message_item_comment_edit_"+b).siblings(".textoverlay")&&a("#message_item_comment_edit_"+b).destroyOverlayInstance(a("#message_item_comment_edit_"+b));var e="#item_feed_comment_text_";1==c&&(e="#photo_feed_comment_text_");a(e+b).show();a("#item_comment_edit_"+b).remove();e=a.inArray(b,m);m.splice(e,1)},A=function(b,c){if(""!=a.trim(a("#message_item_comment_edit_"+b).val())||""!=a("#item_comment_attach_id_"+b).val()){var e=
    0!=a("#message_item_comment_edit_"+b+"_hidden").length?a("#message_item_comment_edit_"+b+"_hidden").val():a("#message_item_comment_edit_"+b).val();a.post(mooConfig.url.base+"/comments/ajax_editComment/"+b,{comment_attach:a("#item_comment_attach_id_"+b).val(),message:e},function(e){a("#message_item_comment_edit_"+b).siblings(".textoverlay")&&a("#message_item_comment_edit_"+b).destroyOverlayInstance(a("#message_item_comment_edit_"+b));a("#item_feed_comment_text_"+b).html(a(e).html());a("#photo_feed_comment_text_"+
    b).html(a(e).html());a("#history_item_comment_"+b).show();a("#history_activity_comment_"+b).show();f.registerImageComment();p(b,c)})}},x=function(b,c){a("#"+b+"_comment_attach_id_"+c).val("");a("#"+b+"_comment_preview_attach_"+c).html("");a("#"+b+"_comment_attach_"+c).show();a("body").trigger("afterRemovePhotoCommentCallback",[])},r=function(b){a("#commentButton_"+b).show();0!=a("#commentForm_"+b).length&&0==a("#commentForm_"+b).siblings("input.messageHidden").length&&(g.init("commentForm_"+b),k.init("commentForm_"+
    b))},C=function(b,c){a(".item_reply_comment_viewmore").each(function(){data=a(this).data();if(data.id==b)return a(this).parent().remove(),!0});div_id="item_comments_reply_"+b;a("#item_newComment_reply_"+b).is(":visible")&&!a("#"+div_id).hasClass("isLoadNew")?a("#item_commentReplyForm"+b).focus():(a("#item_newComment_reply_"+b).show(),a("#item_commentReplyForm"+b).focus(),a.post(mooConfig.url.base+"/comments/browse/comment/"+b+"/id_content:"+div_id+"/is_close_comment:"+c,function(b){""!=b&&(a("#"+
    div_id).hasClass("isLoadNew")&&(a("#"+div_id+">li:not(:last-child)").remove(),a("#"+div_id).removeClass("isLoadNew")),"1"===mooConfig.reply_sort_style?a("#"+div_id).prepend(b):a("#"+div_id).append(b),h.init(),f.registerImageComment())}))},D=function(){a("body").off("click.comment","a.reply_reply_comment_button").on("click.comment","a.reply_reply_comment_button",function(){var b=a(this).data();type=b.type.replace("_"+b.id,"");var e="",d="item_newComment_reply_"+b.id;switch(type){case "item_comments_reply":e=
    "item_commentReplyForm"+b.id;break;case "activitycomments_reply":e="activitycommentReplyForm"+b.id;a("#activitynewComment_reply_"+b.id).is(":visible")||a("#activitynewComment_reply_"+b.id).show();d="activitynewComment_reply_"+b.id;break;case "comments_reply":e="commentReplyForm"+b.id,a("#newComment_reply_"+b.id).is(":visible")||a("#newComment_reply_"+b.id).show(),d="newComment_reply_"+b.id}if(a(this).hasClass("owner"))a("#"+d).attr("style","display:block !important;"),a("#"+e).focus();else if(""==
    a.trim(a("#"+e).val())){var f=a(this).next().html(),h=document.createElement("textarea");h.innerHTML=f;f=h.value;0==a(".messageHidden").length&&g.addMention(b.user,f,e);a("#"+e).val(f);a("#"+e).parent().find(".messageHidden").val("@["+b.user+":"+f+"] ");a("#"+d).attr("style","display:block !important;");a("#"+e).focus()}});var b=0<a("#url_path").length?a("#url_path").val():window.location.pathname;a(document).ready(function(){var c=1;0<=b.indexOf("comment_id:")&&(0<a(".comment_list").length?a("html, body").animate({scrollTop:a(".comment_list").first().offset().top-
        120},1E3):a(document).ajaxStop(function(){c&&0<a(".comment_list").length&&(a("html, body").animate({scrollTop:a(".comment_list").first().offset().top-120},1E3),c=0)}))})};return{ajax_postComment:B,initEditActivityComment:function(){a(".editActivityComment").unbind("click");a(".editActivityComment").click(function(){var b=a(this).data();H(b.activityCommentId)})},cancelEditActivityComment:n,confirmEditActivityComment:z,editItemComment:v,cancelEditItemComment:p,confirmEditItemComment:A,removePhotoComment:x,
    initShowCommentBtn:t,initShowCommentForm:function(){a(".showCommentForm").unbind("click");a(".showCommentForm").click(function(){var b=a(this).data().id;a("#comments_"+b).show();a("#newComment_"+b).show();a("#commentForm_"+b).focus();a("#commentForm_"+b).focus();a("body").trigger("afterShowFormCommentCallback",[])})},initOnCommentForm:function(){t();a(".shareButton").unbind("click");a(".shareButton").click(function(){var b=a(this).data();B(b.id)})},initOnCommentListing:function(){a("textarea:not(.no-grow)").autogrow();
        a("#comments li").hover(function(){a(this).contents(".cross-icon").show()},function(){a(this).contents(".cross-icon").hide()});f.initMoreResults();E.initLikeActivity();u();w()},initOnAjaxLoadCommentEdit:function(){a("textarea:not(.no-grow)").autogrow();L();M();y()},initRemoveItemComment:u,initEditItemComment:w,showCommentButton:r,initRemoveActivityComment:function(){a(".removeActivityComment").unbind("click");a(".removeActivityComment").click(function(){var b=a(this).data();I(b.activityCommentId)})},
    initOnAjaxLoadActivityCommentEdit:function(){J();K();y()},initReplyCommentItem:function(){a("body").off("click.comment","a.item_reply_comment_button").on("click.comment","a.item_reply_comment_button",function(){var b=a(this).data().id;C(b,0)});a("body").off("click.comment","a.item_reply_comment").on("click.comment","a.item_reply_comment",function(){var b=a(this).data();button=a(this);id=b.id;if(""!=a.trim(a("#item_commentReplyForm"+id).val())||""!=a("#item_comment_reply_image_"+id).val())a("#item_commentReplyButton_"+
        id+" a").prepend('<i class="icon-refresh icon-spin"></i>'),a("#item_commentReplyButton_"+id+" a").addClass("disabled"),b="",b=0<a("#item_commentReplyForm"+id).siblings(".messageHidden").length?a("#item_commentReplyForm"+id).siblings(".messageHidden").val():a("#item_commentReplyForm"+id).val(),a.post(mooConfig.url.base+"/comments/ajax_share",{type:"comment",target_id:id,thumbnail:a("#item_comment_reply_image_"+id).val(),message:b},function(b){""!=b&&(a("#item_newComment_reply_"+id).parent().hasClass("isLoadNew")?
        a("#item_newComment_reply_"+id).before(b):"1"===mooConfig.reply_sort_style?a("#item_newComment_reply_"+id).before(b):a("#item_newComment_reply_"+id).after(b),a(".slide").slideDown(),button.removeClass("disabled"),a("#item_commentReplyForm"+id).val(""),a(".commentBox").css("height","27px"),a("#item_comment_reply_preview_image_"+id).html(""),a("#item_comment_reply_image_"+id).val(""),a("#item_comment_reply_button_attach_"+id).show(),f.registerImageComment(),b=a("#item_commentReplyForm"+id),g.resetMention(b),
        h.init())})});a("body").off("click.comment","a.item_reply_comment_viewmore").on("click.comment","a.item_reply_comment_viewmore",function(){var b=a(this).data();C(b.id,b.close)});D()},initReplyReply:D,initCloseComment:function(){a(".closeComment").unbind("click");a(".closeComment").click(function(){var b=a(this).data();a.post(mooConfig.url.base+"/comments/ajax_close",{item_id:b.id,item_type:b.type},function(a){a=JSON.parse(a);1==a.result&&F.alert(a.message)});"1"==b.close?(a(this).html(d.__("close_comment")),
        a(this).data("close",0)):(a(this).html(d.__("open_comment")),a(this).data("close",1))})}}});