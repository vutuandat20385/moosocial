(function(a,b){if(typeof define==="function"&&define.amd){define(["jquery","mooAjax","mooAlert","mooButton","mooPhrase","mooBehavior","tinycon","slimScroll","spinner"],b)}else{if(typeof exports==="object"){module.exports=b(require("jquery"))}else{a.mooNotification=b()}}}(this,function(e,i,q,l,d,n){var f={};var h=true;var s=10000;var p=function(){if(e("#notificationDropdown")){e("#notificationDropdown").unbind("click");e("#notificationDropdown").click(function(){var v=f.show_notification;if(typeof(v)!="undefined"){e(this).next("ul:first").spin("tiny");i.get({url:v},function(w){e("#notifications_list").html(w);e("#notificationDropdown").next("ul:first").spin(false);e(".initSlimScroll").slimScroll({height:"500px"});e("#notifications_list li").hover(function(){e(this).contents().find(".delete-icon").show()},function(){e(this).contents().find(".delete-icon").hide()})})}})}if(e("#conversationDropdown")){e("#conversationDropdown").unbind("click");e("#conversationDropdown").click(function(){var v=f.show_conversation;e(this).next("ul:first").spin("tiny");i.get({url:v},function(w){e("#conversation_list").html(w);e("#conversationDropdown").next("ul:first").spin(false);e(".initSlimScroll").slimScroll({height:"500px"})})})}};var k=function(){var v=f.refresh_notification_url;if(typeof(v)!="undefined"){window.setInterval(function(){e.getJSON(v,function(w){if(e("#notification_count")){e("#notification_count").html(w.notification_count)}if(parseInt(w.notification_count)>0){if(e(".notification_count").length>0){e(".notification_count").html(w.notification_count)}else{e("#notificationDropdown").append('<span class="notification_count">1</span>')}}else{if(e(".notification_count")){e(".notification_count").remove()}}if(parseInt(w.conversation_count)>0){if(e(".conversation_count").length>0){e(".conversation_count").html(w.conversation_count)}else{e("#conversationDropdown").append('<span class="conversation_count">1</span>')}}else{if(e(".conversation_count")){e(".conversation_count").remove()}}}).fail(function(){console.log("Error when calling "+v)})},s)}};var j=function(){e(".removeNotification").unbind("click");e(".removeNotification").on("click",function(){var v=e(this).data();r(v.id)})};var r=function(v){i.get({url:mooConfig.url.base+"/notifications/ajax_remove/"+v},function(x){e("#noti_"+v).slideUp();if(e("#noti_"+v).hasClass("unread")&&e("#notification_count").html()!="0"){var w=parseInt(e(".notification_count").html())-1;if(w==0){e(".notification_count").remove()}else{e(".notification_count").html(w)}e("#notification_count").html(w);Tinycon.setBubble(w)}e("body").trigger("afterRemoveNotificationCallback",[])})};var c=function(){e("#notifications_list_content li").hover(function(){e(this).contents().find(".delete-icon").show()},function(){e(this).contents().find(".delete-icon").hide()});e(".removeNotification").unbind("click");e(".removeNotification").click(function(){var v=e(this).data();r(v.id)});e(".clearAllNotification").unbind("click");e(".clearAllNotification").click(function(){o()});n.initMoreResults()};var o=function(){e.get(mooConfig.url.base+"/notifications/ajax_clear");e(".notification_list").slideUp();e("#new_notifications").fadeOut();e("#notification_count").html("0");e(".notification_count").html("0");Tinycon.setBubble(0);e("body").trigger("afterClearNotificationCallback",[]);return false};var u=function(){e("#notificationButton").unbind("click");e("#notificationButton").click(function(){var v=e("#item_type").val();var w=e("#item_id").val();l.disableButton("notificationButton");e("#notificationButton").spin("small");e.post(mooConfig.url.base+"/notifications/ajax_save",e("#notificationForm").serialize(),function(y){l.enableButton("notificationButton");e("#notificationButton").spin(false);var x=e.parseJSON(y);if(x.result==1){e(".error-message").hide();if(x.is_stop==1){e("#stop_notification_"+v+w).html(d.__("turn_on_notifications"))}else{e("#stop_notification_"+v+w).html(d.__("stop_notifications"))}q.alert(x.message);e("#portlet-config").modal("hide");e("#themeModal").modal("hide")}else{e(".error-message").show();e(".error-message").html(x.message)}})});return false};var m=function(){if(h){p();k()}};var g=function(v){f=v};var t=function(v){h=v};var a=function(v){if(v>0){s=v*1000}};var b=function(){e(".markMsgStatus").unbind("click");e(".markMsgStatus").click(function(){var v=e(this).data();var w=e(this);i.post({url:mooConfig.url.base+"/notifications/mark_read",data:{id:v.id,status:v.status}},function(y){var z=e.parseJSON(y);var x=e("#notification_count").html();if(z.status==="1"){w.parents("li:first").find("a:first").removeClass("unread");w.hide();w.next().show();e("#notification_count").html(parseInt(x)-1);if(parseInt(x)-1>0){if(e(".notification_count").length>0){e(".notification_count").html(parseInt(x)-1)}else{e("#notificationDropdown").append('<span class="notification_count">1</span>')}}else{if(e(".notification_count")){e(".notification_count").remove()}}}else{w.parents("li:first").find("a:first").addClass("unread");w.hide();w.prev().show();e("#notification_count").html(parseInt(x)+1);if(e(".notification_count").length>0){e(".notification_count").html(parseInt(x)+1)}else{e("#notificationDropdown").append('<span class="notification_count">1</span>')}}})});e(".markAllNotificationAsRead").unbind("click");e(".markAllNotificationAsRead").click(function(){i.post({url:mooConfig.url.base+"/notifications/mark_all_read",data:{}},function(v){var w=e.parseJSON(v);if(w.success==true){e(".mark_read").hide();e(".mark_unread").show();e(".notification_count").remove();e("#notification_count").html("0");e("#notifications_list a.unread").removeClass("unread")}})});e(".clearAllNotifications").unbind("click");e(".clearAllNotifications").click(function(){i.post({url:mooConfig.url.base+"/notifications/clear_all_notifications",data:{}},function(v){e(".notification_count").remove();e("#notification_count").html("0");e("#notifications_list").html(v);e("#notificationDropdown").next("ul:first").spin(false);e(".initSlimScroll").slimScroll({height:"500px"})})})};return{init:m,setUrl:g,setActive:t,setInterval:a,removeNotification:r,initAjaxShow:c,initNotification:u,initRemoveNotification:j,initMarkRead:b}}));